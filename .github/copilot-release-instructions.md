# Copilot Instructions – Automated Release Flow (GitHub Actions + GitHub Releases)

These instructions guide GitHub Copilot (and contributors) to implement a consistent, automated release process for repositories that have:
- Multi-module Java builds (e.g., Maven aggregator with modules like `common`, `server`, `agent`)
- Optional Node.js frontend (bundled artifacts published with backend)

Adapt steps if only one stack is present. Copilot should proactively create or update workflows, version bumps, changelog generation, and release assets when asked about “releases”, “publishing”, “versioning”, or “deploying”.

---
## Goals
1. Enforce SemVer versioning (`MAJOR.MINOR.PATCH`) and lightweight tags (`vX.Y.Z`).
2. Automate build, test, changelog creation, artifact packaging, and release publishing.
3. Minimize manual steps: only approve PRs and trigger workflows intentionally.
4. Support reproducible artifacts: shaded JARs, checksums, optional signatures, frontend build bundle.
5. Provide clear fallback manual commands.

---
## Versioning Strategy
| Aspect | Guidance |
|--------|----------|
| Development versions | Use `-SNAPSHOT` (Maven) after a release commit. |
| Tags | `vX.Y.Z` only; no leading zeros. |
| Increment rules | PATCH for fixes, MINOR for backward-compatible features, MAJOR for breaking changes. |
| Pre-releases | Use `vX.Y.Z-rc.N` or `-beta.N`; mark GitHub Release as pre-release. |
| Source of truth | The version declared in the root `pom.xml` (and synchronized to modules) + optionally `package.json` for frontend. |

Copilot: When asked to “bump version”, generate a PR that updates `pom.xml` + any `package.json` and adds a pending changelog section.

---
## Branching Model
| Branch | Purpose |
|--------|---------|
| `main` | Always releasable; contains latest stable (or next) snapshot. |
| `release/x.y` (optional) | Stabilization for large MAJOR/MINOR releases; merge back after publishing. |
| Hotfix off tag | Branch from last `vX.Y.Z` tag for urgent patch; merge into `main` post-release. |

Copilot: Suggest hotfix branch naming `hotfix/x.y.z-issueNNN` when user references urgent production fixes.

---
## Workflows Overview
1. CI (`ci.yml`): build + test on pushes and PRs.
2. Release Preparation (`release-prepare.yml`): manual dispatch – bump version, generate changelog draft, open PR.
3. Release Publishing (`release-publish.yml`): triggers on tag push `v*` or published GitHub Release – build artifacts, attach, optionally deploy.
4. (Optional) Pre-release / RC workflow (`release-prerelease.yml`): same as publish but marks pre-release.

Copilot: If workflows missing, offer to create them with minimal defaults.

---
## Artifacts & Outputs
| Artifact | Path (example) | Notes |
|----------|----------------|-------|
| Shaded agent JAR | `agent/target/*-shaded.jar` | Include classifier if needed. |
| Shaded server JAR | `server/target/*-shaded.jar` | Runnable via `java -jar`. |
| Module JARs | `common/target/*.jar` | If published to a registry. |
| Frontend bundle | `frontend/dist/` zipped as `frontend-dist.zip` | Generated by `npm run build`. |
| Checksums | `.sha256` alongside each artifact | Use `shasum -a 256`. |
| Signatures (optional) | `.asc` files | Requires GPG secret key import. |
| Changelog | `CHANGELOG.md` | Updated per release; slice commits between tags. |

---
## Required Secrets / Settings
| Secret | Purpose |
|--------|---------|
| `GPG_PRIVATE_KEY` (base64 / ASCII armor) | Artifact signing (Maven Central). |
| `GPG_PASSPHRASE` | Unlock key. |
| `OSSRH_USERNAME` / `OSSRH_PASSWORD` | Deploy to Sonatype (if applicable). |
| `NPM_TOKEN` | Publish frontend package (if packaged). |
| `GH_TOKEN` / default `GITHUB_TOKEN` | Create releases, PRs, changelog retrieval. |

Copilot: Warn if user mentions publishing but no secrets configured. Suggest adding them in repo settings.

---
## Changelog Conventions
Options:
1. Conventional Commits: parse commit subjects.
2. GitHub API: list merged PRs between last tag and `HEAD`.

Sections recommended: Added / Changed / Deprecated / Removed / Fixed / Security.

Copilot: When asked “generate changelog”, produce a diff between last `v*` tag and current `HEAD` grouped by labels or PR titles.

---
## Sample Workflow: CI (`.github/workflows/ci.yml`)
```yaml
name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: Maven Build
        run: ./mvnw -q clean verify
      - name: Frontend install
        working-directory: frontend
        run: npm ci
      - name: Frontend build
        working-directory: frontend
        run: npm run build
      - name: Upload test reports (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: '**/surefire-reports/*.txt'
```

## Sample Workflow: Release Preparation (`release-prepare.yml`)
```yaml
name: Release Prepare
on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Release version (e.g. 1.4.0)'
        required: true
jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - name: Bump Maven Version
        run: |
          ./mvnw -q versions:set -DnewVersion="${{ inputs.target_version }}" -DgenerateBackupPoms=false
      - name: Bump Node Version (if exists)
        working-directory: frontend
        run: |
          if [ -f package.json ]; then
            jq '.version = "'${{ inputs.target_version }}'"' package.json > package.json.tmp && mv package.json.tmp package.json
          fi
      - name: Generate Changelog Fragment
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 || echo "")
          echo "Last tag: $LAST_TAG" >&2
          echo "## ${ { inputs.target_version } } - $(date +%Y-%m-%d)" > _release_changelog.md
          echo >> _release_changelog.md
          git log --pretty=format:'* %s (%h)' ${LAST_TAG}..HEAD >> _release_changelog.md || true
      - name: Update CHANGELOG
        run: |
          cat _release_changelog.md CHANGELOG.md > CHANGELOG.new && mv CHANGELOG.new CHANGELOG.md
      - name: Commit and PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: release/${{ inputs.target_version }}
          title: "Release ${ { inputs.target_version } }"
          body: "Automated release preparation. Review changelog & version numbers."
          commit-message: "chore: prepare release ${{ inputs.target_version }}"
```

## Sample Workflow: Publish (`release-publish.yml`)
```yaml
name: Release Publish
on:
  push:
    tags: [ 'v*' ]
  release:
    types: [ published ]
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Build Backend
        run: ./mvnw -q -DskipTests package
      - name: Build Frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build
          zip -r ../frontend-dist.zip dist
      - name: Collect Artifacts
        run: |
          mkdir release
          cp agent/target/*-shaded.jar release/ || true
          cp server/target/*-shaded.jar release/ || true
          cp frontend-dist.zip release/ || true
          for f in release/*; do shasum -a 256 "$f" > "$f.sha256"; done
      - name: Create / Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Post-Release Snapshot Bump (optional)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          NEXT=$(echo $VERSION | awk -F. '{print $1"."$2"."$3+1"-SNAPSHOT"}')
          ./mvnw -q versions:set -DnewVersion="$NEXT" -DgenerateBackupPoms=false
          git commit -am "chore: start next development cycle $NEXT" || true
          git push origin HEAD:main || true
```

---
## Manual Fallback Commands (Local)
```bash
# 1. Ensure clean build
./mvnw -q clean verify
cd frontend && npm ci && npm run build && cd ..

# 2. Decide version
export VERSION=1.2.3

# 3. Bump versions
./mvnw -q versions:set -DnewVersion="$VERSION" -DgenerateBackupPoms=false
jq '.version = "'$VERSION'"' frontend/package.json > frontend/package.tmp && mv frontend/package.tmp frontend/package.json

# 4. Update CHANGELOG
LAST_TAG=$(git describe --tags --abbrev=0 || echo "")
{ echo "## $VERSION - $(date +%Y-%m-%d)"; echo; git log --pretty=format:'* %s (%h)' $LAST_TAG..HEAD; echo; cat CHANGELOG.md; } > CHANGELOG.new
mv CHANGELOG.new CHANGELOG.md

# 5. Commit + tag
git commit -am "release: $VERSION"
git tag -a v$VERSION -m "Release $VERSION"
git push origin main --tags

# 6. Create release with assets (GitHub CLI)
mkdir release
cp server/target/*-shaded.jar release/ 2>/dev/null || true
cp agent/target/*-shaded.jar release/ 2>/dev/null || true
zip -r release/frontend-dist.zip frontend/dist 2>/dev/null || true
for f in release/*; do shasum -a 256 "$f" > "$f.sha256"; done
gh release create v$VERSION release/* -t "v$VERSION" -n "See CHANGELOG.md for details"

# 7. Start next snapshot
NEXT=$(echo $VERSION | awk -F. '{print $1"."$2"."$3+1"-SNAPSHOT"}')
./mvnw -q versions:set -DnewVersion="$NEXT" -DgenerateBackupPoms=false
git commit -am "chore: start $NEXT"
git push origin main
```

---
## Copilot Assistance Guidelines
When user asks:
| Prompt Style | Copilot Should |
|--------------|----------------|
| “Set up release automation” | Generate missing workflows (`ci.yml`, `release-prepare.yml`, `release-publish.yml`). |
| “Bump version to X.Y.Z” | Propose PR changes: update versions, prepend changelog section. |
| “Generate changelog” | Diff last tag vs HEAD. Group by PR labels if accessible. |
| “Publish release” | Confirm tag exists; if not, propose tag creation and push, then run publish workflow. |
| “Artifacts missing” | Check build paths; suggest verifying shaded jar goals in `pom.xml`. |

Tone: Be concise, actionable. Offer to create/edit files immediately using patches.

Validation Steps Copilot Should Run (if tools available):
1. Build succeeds (`./mvnw -q clean verify`).
2. Frontend builds (`npm run build`).
3. Tag points to commit with version bump.
4. Release contains expected assets.

---
## Troubleshooting
| Issue | Cause | Fix |
|-------|-------|-----|
| Artifact missing in Release | Not built before publish step | Ensure `package` phase or add explicit build step. |
| Wrong version in JAR manifest | Version bump after build | Bump versions first, then rebuild. |
| Changelog empty | No previous tag | Handle first release: include all commits since repo init. |
| Signature failures | Bad GPG key import format | Export ASCII-armored private key; remove passphrase mismatch. |
| Tag push blocked | Protection rules on tags | Adjust protection or use maintainer account with rights. |

---
## Extensibility / Next Steps
Optional enhancements Copilot can suggest:
- Add SBOM generation (e.g., `cyclonedx-maven-plugin`).
- Add dependency scanning (`ossindex` or `dependency-check` action).
- Add provenance/SLSA build attestation.
- Add Docker image build + push in publish workflow.
- Add release announcement (Slack / Matrix) via webhook.

---
## Summary
This document defines a repeatable release pipeline using GitHub Actions and Releases for combined Java + Node projects. Copilot should treat missing workflows and version bumps as actionable tasks, proposing concrete file edits and verifying builds before guiding publication.
